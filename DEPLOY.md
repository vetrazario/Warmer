# Руководство по развертыванию Email Warmer на Ubuntu 22.04

В этом руководстве описаны шаги по установке, настройке и обновлению приложения Email Warmer на сервере Ubuntu 22.04.

## Требования

- Ubuntu 22.04 LTS
- Минимум 2 ГБ оперативной памяти
- Минимум 20 ГБ дискового пространства
- Права суперпользователя (root)
- Доступ к серверу по SSH

## Быстрая установка

### 1. Подключение к серверу

```bash
ssh user@your-server-ip
```

### 2. Загрузка скрипта установки

```bash
wget -O install.sh https://raw.githubusercontent.com/yourusername/email-warmer/main/install.sh
chmod +x install.sh
```

### 3. Запуск скрипта установки

```bash
sudo ./install.sh
```

Скрипт запросит следующую информацию:
- Домен или IP-адрес сервера
- Использовать ли SSL (рекомендуется для продакшена)
- URL Git-репозитория (можно оставить по умолчанию)
- Порт для приложения (по умолчанию 5000)
- Ввести секретные ключи вручную или сгенерировать автоматически

После ввода всей необходимой информации, скрипт выполнит следующие действия:
1. Обновление системы
2. Установка необходимых пакетов (Docker, Docker Compose, Nginx, Certbot)
3. Клонирование репозитория
4. Настройка переменных окружения
5. Настройка Docker и Docker Compose
6. Создание скриптов управления
7. Настройка Nginx и SSL (если выбрано)
8. Настройка автоматического резервного копирования
9. Запуск приложения

## Управление приложением

После установки вы можете использовать следующие команды для управления приложением:

### Основные команды
Все команды выполняются из директории `/var/www/email-warmer`:

```bash
# Проверка статуса
./status.sh

# Просмотр логов
./logs.sh

# Перезапуск приложения
./restart.sh

# Остановка приложения
./stop.sh

# Запуск приложения
./start.sh
```

### Обновление приложения

Для обновления приложения до последней версии:

```bash
# Зайти в директорию приложения
cd /var/www/email-warmer

# Запустить скрипт обновления
./update.sh
```

Скрипт обновления выполнит следующие действия:
1. Создание резервной копии текущей базы данных и конфигурации
2. Остановка контейнеров Docker
3. Получение последних изменений из Git-репозитория
4. Запуск контейнеров с новой версией приложения

### Резервное копирование

Резервные копии создаются автоматически каждый день в 2:00 утра.
Для ручного создания резервной копии:

```bash
./backup.sh
```

Резервные копии хранятся в директории `/var/backups/email-warmer` в формате `.tar.gz`.
Автоматически удаляются копии старше 7 дней.

## Структура директорий

```
/var/www/email-warmer     - Директория приложения
├── .env                  - Файл конфигурации
├── docker-compose.yml    - Конфигурация Docker Compose
├── app/                  - Исходный код приложения
├── start.sh              - Скрипт запуска
├── stop.sh               - Скрипт остановки
├── restart.sh            - Скрипт перезапуска
├── update.sh             - Скрипт обновления
├── backup.sh             - Скрипт резервного копирования
├── logs.sh               - Скрипт просмотра логов
└── status.sh             - Скрипт проверки статуса

/var/data/mongodb         - Данные MongoDB

/var/backups/email-warmer - Резервные копии
```

## Устранение неполадок

### 1. Проблемы с Docker

Если контейнеры не запускаются:

```bash
# Проверка статуса Docker
sudo systemctl status docker

# Перезапуск Docker
sudo systemctl restart docker

# Проверка логов Docker
sudo journalctl -u docker

# Проверка запущенных контейнеров
docker ps -a
```

### 2. Проблемы с Nginx

Если возникли проблемы с веб-сервером:

```bash
# Проверка конфигурации Nginx
sudo nginx -t

# Перезапуск Nginx
sudo systemctl restart nginx

# Проверка логов Nginx
sudo tail -f /var/log/nginx/error.log
```

### 3. Проблемы с приложением

Если приложение работает некорректно:

```bash
# Просмотр логов приложения
cd /var/www/email-warmer
./logs.sh

# Проверка состояния контейнеров
docker-compose ps

# Перезапуск контейнеров
docker-compose restart
```

## Дополнительная информация

Более подробная информация доступна в файле `/var/www/email-warmer/README.txt`, созданном при установке.

## Удаление приложения

Если вам необходимо полностью удалить приложение:

```bash
# Остановка и удаление контейнеров
cd /var/www/email-warmer
docker-compose down -v

# Удаление файлов приложения
sudo rm -rf /var/www/email-warmer

# Удаление данных MongoDB
sudo rm -rf /var/data/mongodb

# Удаление Nginx-конфигурации
sudo rm -f /etc/nginx/sites-enabled/email-warmer
sudo rm -f /etc/nginx/sites-available/email-warmer
sudo systemctl reload nginx

# Удаление systemd-сервиса
sudo systemctl disable email-warmer
sudo rm -f /etc/systemd/system/email-warmer.service
sudo systemctl daemon-reload

# Удаление задания в cron
sudo rm -f /etc/cron.d/email-warmer-backup
``` 